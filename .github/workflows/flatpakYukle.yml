# Bu araÃ§ @keyiflerolsun tarafÄ±ndan | @KekikAkademi iÃ§in yazÄ±lmÄ±ÅŸtÄ±r.

name: Flatpak YÃ¼kleyici

on: [push, pull_request]

jobs:
  FlatpakYukleyici:
    name    : Flatpak YÃ¼kleyici
    runs-on : ubuntu-latest

    steps:
      - name: Depo KontrolÃ¼
        uses: actions/checkout@v3

      - name: Python 3.10.8 YÃ¼kle
        uses: actions/setup-python@v4
        with:
          python-version: "3.10.8"

      - name: DeÄŸiÅŸkenleri Ayarla
        run : |
          PAKET_V=$(cat setup.py | grep -oP "(?<=version      = \").*?(?=\")")
          PAKET_ADI=$(cat setup.py | sed -n 's/.*"\(Shared\/\([^"]*\)\.desktop\)".*/\2/p')

          echo "PAKET_V=$PAKET_V" >> $GITHUB_ENV
          echo "PAKET_ADI=$PAKET_ADI" >> $GITHUB_ENV

          echo "Paket AdÄ±: $PAKET_ADI"
          echo "Paket SÃ¼rÃ¼mÃ¼: $PAKET_V"

      - name: Gereksinimleri YÃ¼kle
        run : |
          python -m pip install --upgrade pip
          pip install setuptools wheel pyyaml
          sudo apt update -qq
          sudo apt install -y flatpak flatpak-builder --fix-missing
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo --user
          flatpak remote-add --if-not-exists flathub-beta https://flathub.org/beta-repo/flathub-beta.flatpakrepo --user
          flatpak update && flatpak upgrade
          flatpak install flathub org.freedesktop.{Platform,Sdk}//22.08 -y --noninteractive --user

      - name: Paketle
        run : |
          mv Shared/*.yml . && mv Shared/SRC .
          flatpak-builder --repo=github --force-clean build-dir $PAKET_ADI.yml
          flatpak build-bundle github $PAKET_ADI.flatpak $PAKET_ADI

      - name: ArtÄ±klarÄ± Temizle
        run : |
          rm -rf .flatpak* .vscode build-dir && find . | grep -E "(__pycache__|\.pyc|\.pyo$)" | xargs rm -rf

      - name: Paketi GitHub'a YÃ¼kle
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PAKET_ADI }}
          path: ./${{ env.PAKET_ADI }}.flatpak

      - name: GitHub Release OluÅŸtur
        uses: softprops/action-gh-release@v1
        env :
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name   : ${{ env.PAKET_V }}
          body       : ðŸ•Š **${{ env.PAKET_ADI }}** _GitHub tarafÄ±ndan_ `${{ env.PAKET_V }}`'e _Otomatik olarak paketlendi.._
          draft      : false
          prerelease : false
          files      : |
            ./${{ env.PAKET_ADI }}.flatpak